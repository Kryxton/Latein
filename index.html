<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vokabeltrainer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { 
      padding-top: 4rem; 
      background: #f8f9fa; 
      font-family: "Segoe UI", sans-serif; 
      transition: background-color 0.3s ease, color 0.3s ease; 
    }
    .hidden { display: none !important; }
    .smooth { transition: all 0.3s ease; }
    #home-btn { 
      font-size: 1.5rem; 
      color: #0d6efd; 
      cursor: pointer; 
      z-index: 1030; 
    }
    .card-choice { 
      cursor: pointer; 
      border: none; 
      border-radius: 0.75rem; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
    .card-choice:hover:not(.disabled) { 
      transform: translateY(-3px); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    }
    .disabled { opacity: 0.5; cursor: not-allowed !important; }
    .dropdown-menu { max-height: 300px; overflow-y: auto; }
    .chap-checkbox { margin-right: 0.5rem; }
    .btn-chap { margin: 0.25rem; }
    .flash-green { animation: flash-green 0.8s both; }
    .flash-yellow { animation: flash-yellow 0.8s both; }
    .flash-red { animation: flash-red 0.8s both; }
    @keyframes flash-green { 
      from { background: rgba(40,167,69,0.3); } 
      to { background: transparent; } 
    }
    @keyframes flash-yellow { 
      from { background: rgba(255,193,7,0.3); } 
      to { background: transparent; } 
    }
    @keyframes flash-red { 
      from { background: rgba(220,53,69,0.3); } 
      to { background: transparent; } 
    }
    /* Mobile Optimierung */
    .container { padding: 1rem; }
    .card { 
      max-width: 100%; 
      width: 100%; 
      margin: 0 auto; 
    }
    @media (max-width: 576px) {
      .navbar-brand { font-size: 1rem; }
      #home-btn { font-size: 1.2rem; }
      .card-body { padding: 1rem; }
      .btn { font-size: 0.9rem; }
      h5 { font-size: 1.1rem; }
      .row-cols-md-4 > .col { margin-bottom: 1rem; }
    }
    /* Darkmode-Styling */
    body.dark-mode {
      background-color: #121212;
      color: #eee;
    }
    body.dark-mode .navbar {
      background-color: #1a1a1a;
      border-bottom: 1px solid #333;
    }
    body.dark-mode .card {
      background-color: #1a1a1a;
      color: #eee;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    body.dark-mode .list-group-item {
      background-color: #2a2a2a;
      color: #eee;
      border-color: #444;
    }
    body.dark-mode .btn-outline-secondary {
      color: #eee;
      border-color: #eee;
    }
    body.dark-mode .btn-outline-secondary:hover {
      background-color: #eee;
      color: #333;
    }
    body.dark-mode .text-muted {
      color: #ccc !important;
    }
    .navbar .container-fluid {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #darkmode-toggle {
      margin: 0;
      padding: 0;
      color: inherit;
    }
    #darkmode-icon {
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg fixed-top border-bottom">
    <div class="container-fluid px-3">
      <div class="d-flex align-items-center">
        <span id="flame-count" class="text-warning me-2"></span>
        <i id="home-btn" class="bi bi-house-door-fill" title="Zurück zum Start"></i>
        <span class="navbar-brand ms-2">Vokabeltrainer</span>
      </div>
      <div class="d-flex align-items-center">
        <button id="darkmode-toggle" class="btn btn-link me-2">
          <i class="bi bi-moon" id="darkmode-icon"></i>
        </button>
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            Kapitel für Test
          </button>
          <ul class="dropdown-menu" id="lesson-dropdown">
            <li>
              <label class="dropdown-item">
                <input type="checkbox" class="form-check-input chap-checkbox" data-lesson="all" checked>
                Alle Kapitel
              </label>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container py-3">
    <!-- Startseite -->
    <div id="main-menu" class="row row-cols-1 row-cols-md-4 g-3">
      <div class="col"><div id="start-test" class="card card-choice smooth"><div class="card-body text-center py-4"><i class="bi bi-play-circle-fill display-4 text-primary"></i><h5 class="mt-2">Neuer Test</h5></div></div></div>
      <div class="col"><div id="test-red" class="card card-choice smooth"><div class="card-body text-center py-4"><i class="bi bi-arrow-repeat display-4 text-danger"></i><h5 class="mt-2">Rote Vokabeln</h5></div></div></div>
      <div class="col"><div id="view-chapters" class="card card-choice smooth"><div class="card-body text-center py-4"><i class="bi bi-book display-4 text-secondary"></i><h5 class="mt-2">Kapitel ansehen</h5></div></div></div>
      <div class="col"><div id="custom-lists" class="card card-choice smooth"><div class="card-body text-center py-4"><i class="bi bi-list display-4 text-info"></i><h5 class="mt-2">Eigene Listen</h5></div></div></div>
      <div class="col"><div id="start-challenge" class="card card-choice smooth"><div class="card-body text-center py-4"><i class="bi bi-bar-chart-line display-4 text-warning"></i><h5 class="mt-2">Challenge</h5><small>20 Vokabeln</small></div></div></div>
    </div>

    <!-- Test-Typ Auswahl -->
    <div id="test-type-selection" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3 text-center">
          <h5 class="mb-3">Wähle den Test-Typ</h5>
          <button id="test-chapters" class="btn btn-primary mb-2 w-100">Kapitel</button>
          <button id="test-lists" class="btn btn-primary w-100">Eigene Listen</button>
        </div>
      </div>
    </div>

    <!-- Listen ausfragen -->
    <div id="list-selection" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3">
          <h5 class="text-center mb-3">Wähle eine Liste</h5>
          <ul id="list-selection-ul" class="list-group"></ul>
          <button id="back-from-list-selection" class="btn btn-outline-secondary w-100 mt-3">Zurück</button>
        </div>
      </div>
    </div>

    <!-- Wortanzahl-Auswahl -->
    <div id="count-selection" class="text-center my-4 hidden smooth">
      <button class="btn btn-outline-primary mx-1 mb-2" data-count="10">10 Wörter</button>
      <button class="btn btn-outline-primary mx-1 mb-2" data-count="20">20 Wörter</button>
      <button id="choose-count" class="btn btn-outline-secondary mx-1 mb-2">Eigenes</button>
      <div id="custom-count-div" class="mt-2 hidden">
        <input type="number" id="custom-count" class="form-control d-inline-block w-auto" placeholder="Anzahl" min="1">
        <button id="custom-count-btn" class="btn btn-primary ms-2">OK</button>
      </div>
    </div>

    <!-- Kapitel ansehen -->
    <div id="chapter-display" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3">
          <h5 class="text-center mb-3">Kapitel ansehen</h5>
          <input type="text" id="search-input" class="form-control mb-3" placeholder="Suche ein Wort">
          <div id="chapter-selection" class="text-center my-3"></div>
          <ul id="chapter-list" class="list-group mb-3"></ul>
          <button id="back-from-chapter" class="btn btn-outline-secondary w-100">Zurück</button>
        </div>
      </div>
    </div>

    <!-- Challenge Einstellung -->
    <div id="challenge-display" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3 text-center">
          <h5 class="mb-3">Bis Kapitel … gelernt?</h5>
          <input type="range" id="challenge-range" min="1" max="13" value="1">
          <div class="mt-2"><span id="challenge-val">Kapitel 1</span></div>
          <button id="challenge-start" class="btn btn-warning mt-3">Challenge starten</button>
        </div>
      </div>
    </div>

    <!-- Quiz -->
    <div id="quiz-section" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3">
          <h4 id="question-term" class="text-center mb-3"></h4>
          <input id="answer-input" type="text" class="form-control mb-2" placeholder="Deine Antwort" autocomplete="off">
          <div id="feedback" class="mb-2"></div>
          <button id="submit-answer" class="btn btn-success w-100">Prüfen</button>
          <div id="progress" class="mt-2 text-end text-muted"></div>
        </div>
      </div>
    </div>

    <!-- Ergebnis -->
    <div id="result-section" class="text-center hidden smooth mt-3">
      <h4 class="mb-3">Auswertung</h4>
      <p id="result-text"></p>
      <div id="review-container" class="text-start"></div>
      <button id="back-menu" class="btn btn-outline-secondary mt-3">Zurück</button>
    </div>

    <!-- Eigene Listen -->
    <div id="custom-lists-section" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3">
          <h5 class="text-center mb-3">Eigene Vokabellisten</h5>
          <button id="create-new-list" class="btn btn-primary mb-3 w-100">Neue Liste erstellen</button>
          <ul id="custom-lists-ul" class="list-group mb-3"></ul>
          <button id="back-from-lists" class="btn btn-outline-secondary w-100">Zurück</button>
        </div>
      </div>
    </div>

    <!-- Listendetails -->
    <div id="list-detail-section" class="hidden smooth mt-3">
      <div class="card">
        <div class="card-body p-3">
          <h5 id="list-detail-title" class="text-center mb-3"></h5>
          <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Begriff" id="new-term">
            <input type="text" class="form-control" placeholder="Bedeutung" id="new-meaning">
            <button class="btn btn-primary" id="add-vocab-inline">Hinzufügen</button>
          </div>
          <ul id="list-detail-ul" class="list-group mb-3"></ul>
          <button id="back-from-detail" class="btn btn-outline-secondary w-100">Zurück</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ### Daten ###
    const lessons = {
      "Lektion 1": [
        { term:"puella",  meaning:"das Mädchen" },
        { term:"serva",   meaning:"die Sklavin, die Dienerin" },
        { term:"silva",   meaning:"der Wald" },
        { term:"via",     meaning:"der Weg, die Straße" },
        { term:"villa",   meaning:"das Haus, das Landhaus" },
        { term:"avus",    meaning:"der Großvater" },
        { term:"campus",  meaning:"das Feld, der freie Platz" },
        { term:"equus",   meaning:"das Pferd" },
        { term:"murus",   meaning:"die Mauer" },
        { term:"servus",  meaning:"der Sklave, der Diener" },
        { term:"vicus",   meaning:"das Dorf, die Gasse" },
        { term:"et",      meaning:"und" },
        { term:"familia", meaning:"die Familie" }
      ],
      "Lektion 2": [
        { term:"esse",    meaning:"sein, sich befinden" },
        { term:"est",     meaning:"er (sie, es) ist" },
        { term:"sunt",    meaning:"sie sind" },
        { term:"amīca",   meaning:"die Freundin" },
        { term:"rīdēre",  meaning:"lachen, auslachen" },
        { term:"nōn",     meaning:"nicht" },
        { term:"cūr?",    meaning:"warum?" },
        { term:"pārēre",  meaning:"gehorchen" },
        { term:"monēre",  meaning:"mahnen, ermahnen" },
        { term:"dēbēre",  meaning:"müssen, sollen" },
        { term:"quid?",   meaning:"was?" },
        { term:"timēre",  meaning:"fürchten, Angst haben" },
        { term:"oculus",  meaning:"das Auge" },
        { term:"dolēre",  meaning:"schmerzen, wehtun" },
        { term:"nunc",    meaning:"nun, jetzt" },
        { term:"tacēre",  meaning:"schweigen, verschweigen" },
        { term:"Lydus servus", meaning:"der Sklave Lydus" }
      ],
      "Lektion 3": [
        { term:"domīnus", meaning:"der Herr" },
        { term:"ibi",     meaning:"dort" },
        { term:"sedēre",  meaning:"sitzen" },
        { term:"sed",     meaning:"aber, sondern" },
        { term:"respondēre", meaning:"antworten" },
        { term:"augēre",     meaning:"vergrößern, vermehren" },
        { term:"nam",        meaning:"denn, nämlich" },
        { term:"tamen",      meaning:"dennoch, jedoch" },
        { term:"adhūc",      meaning:"bis jetzt, noch" },
        { term:"neque",      meaning:"und nicht, auch nicht" },
        { term:"neque ... neque", meaning:"weder ... noch" },
        { term:"quis?",      meaning:"wer?" },
        { term:"docēre",     meaning:"lehren, unterrichten" },
        { term:"lingua",     meaning:"die Sprache, die Rede" }
      ],
      "Lektion 4": [
        { term:"gaudēre",  meaning:"sich freuen" },
        { term:"amīcus",   meaning:"der Freund" },
        { term:"bene",     meaning:"gut" },
        { term:"studēre",  meaning:"sich bemühen, studieren" },
        { term:"tabula",   meaning:"die Schreib-Tafel, das Gemälde" },
        { term:"tenēre",   meaning:"halten, festhalten, besitzen; beherrschen" },
        { term:"praebēre", meaning:"geben, hinhalten" },
        { term:"iam",      meaning:"schon, bereits; nun" },
        { term:"prīmō",    meaning:"zuerst" },
        { term:"tum",      meaning:"da, dann, darauf, damals" },
        { term:"rēctē",    meaning:"richtig, zu Recht" },
        { term:"nōn iam",  meaning:"nicht mehr" },
        { term:"saepe",    meaning:"oft" },
        { term:"numquam",  meaning:"niemals" },
        { term:"sīc",      meaning:"so" },
        { term:"semper",   meaning:"immer" }
      ],
      "Lektion 5": [
        { term:"sonus",     meaning:"der Ton, der Klang, das Geräusch" },
        { term:"terrēre",   meaning:"erschrecken" },
        { term:"latēre",    meaning:"verborgen sein" },
        { term:"subitō",    meaning:"plötzlich" },
        { term:"gladius",   meaning:"das Schwert" },
        { term:"scelerātus",meaning:"der Verbrecher" },
        { term:"flēre",     meaning:"weinen, beweinen" },
        { term:"placēre",   meaning:"gefallen" },
        { term:"torquēre",  meaning:"drehen; quälen" },
        { term:"tantum",    meaning:"nur" },
        { term:"cui?",      meaning:"wem?" },
        { term:"statim",    meaning:"sofort" },
        { term:"etiam",     meaning:"auch, sogar" },
        { term:"iterum",    meaning:"wiederum, zum zweiten Mal" },
        { term:"itaque",    meaning:"deshalb" }
      ],
      "Lektion 6": [
        { term:"cibus",    meaning:"die Nahrung, die Speise, das Futter" },
        { term:"habēre",   meaning:"haben, halten" },
        { term:"aqua",     meaning:"das Wasser" },
        { term:"complēre", meaning:"auffüllen, erfüllen" },
        { term:"cōpia",    meaning:"die Menge, der Vorrat" },
        { term:"ventus",   meaning:"der Wind" },
        { term:"dēlēre",   meaning:"zerstören, vernichten" },
        { term:"populus",  meaning:"das Volk" },
        { term:"Aeolus",   meaning:"(der Gott der Winde)" },
        { term:"deus",     meaning:"der Gott, die Gottheit" },
        { term:"nātūra",   meaning:"die Natur, das Wesen, die Beschaffenheit" },
        { term:"flūvius",  meaning:"der Fluss" },
        { term:"profectō", meaning:"sicherlich, tatsächlich" },
        { term:"gratia",   meaning:"der Dank" },
        { term:"gratiam habere", meaning:"danken, dankbar sein" }
      ],
      "Lektion 7": [
        { term:"valēre",   meaning:"gesund sein, stark sein, Einfluss haben" },
        { term:"valē!",    meaning:"Leb wohl!" },
        { term:"valēte!",  meaning:"Lebt wohl!" },
        { term:"diū",      meaning:"lange (Zeit)" },
        { term:"lacrima",  meaning:"die Träne" },
        { term:"vidēre",   meaning:"sehen" },
        { term:"movēre",   meaning:"bewegen, beeindrucken" },
        { term:"mox",      meaning:"bald" },
        { term:"tandem",   meaning:"endlich" },
        { term:"īnsula",   meaning:"die Insel; der Wohnblock" },
        { term:"Rōma",     meaning:"Rom" },
        { term:"turba",    meaning:"die (Menschen-)Menge" },
        { term:"toga",     meaning:"die Toga" },
        { term:"tunica",   meaning:"die Tunika" },
        { term:"fīlia",    meaning:"die Tochter" },
        { term:"laetitia", meaning:"die Freude" }
      ],
      "Lektion 8": [
        { term:"amāre",     meaning:"lieben" },
        { term:"libenter",  meaning:"gerne" },
        { term:"domina",    meaning:"die Herrin, die Dame" },
        { term:"rogāre",    meaning:"fragen, bitten" },
        { term:"labōrō",    meaning:"arbeiten, sich anstrengen" },
        { term:"parāre",    meaning:"(vor)bereiten, vorhaben (m. Inf.); erwerben" },
        { term:"vocāre",    meaning:"rufen; nennen, benennen" },
        { term:"ubi?",      meaning:"wo?" },
        { term:"properāre", meaning:"eilen, sich beeilen" },
        { term:"cena",      meaning:"das Essen, die Mahlzeit" }
      ],
      "Lektion 9": [
        { term: "cēnāre",       meaning:["essen"] },
        { term: "spectāre",     meaning:["betrachten", "anschauen", "hinsehen"] },
        { term: "dubitāre",     meaning:["zweifeln", "zögern (m. Inf.)"] },
        { term: "Rōmānus",      meaning:["der Römer", "der Einwohner Roms"] },
        { term: "pūgna",        meaning:["der Kampf"] },
        { term: "pūgnāre",      meaning:["kämpfen"] },
        { term: "superāre",     meaning:["besiegen", "überwinden", "übertreffen"] },
        { term: "modestia",     meaning:["die Bescheidenheit", "der Anstand"] },
        { term: "superbia",     meaning:["der Stolz", "der Hochmut"] },
        { term: "Syria",        meaning:["Syrien"] },
        { term: "patria",       meaning:["die Heimat"] },
        { term: "prōvincia",    meaning:["die Provinz"] },
        { term: "clementia",    meaning:["die Milde", "die Nachsicht"] },
        { term: "imperāre",     meaning:["befehlen", "herrschen (über)"] },
        { term: "populīs imperāre", meaning:["über (die) Völker herrschen"] },
        { term: "dolus",        meaning:["die List", "die Täuschung"] },
        { term: "iniūria",      meaning:["das Unrecht", "die Beleidigung", "die Rechtsverletzung"] },
        { term: "captīvus",     meaning:["der Kriegsgefangene"] },
        { term: "fīlius",       meaning:["der Sohn"] }
      ],
      "Lektion 10": [
        { term: "patēre",       meaning:["offenstehen"] },
        { term: "exspectāre",   meaning:["warten (auf)", "erwarten"] },
        { term: "venīre",       meaning:["kommen"] },
        { term: "audīre",       meaning:["hören"] },
        { term: "nihil",        meaning:["nichts"] },
        { term: "lūdus",        meaning:["das Spiel", "die Schule"] },
        { term: "scīre",        meaning:["wissen", "kennen", "verstehen"] },
        { term: "unde?",        meaning:["woher?"] },
        { term: "Europa",       meaning:["Europa"] },
        { term: "Crēta",        meaning:["Kreta"] },
        { term: "dēsīderāre",   meaning:["sich sehnen nach", "vermisse n („Ich sehne mich danach, die Heimat zu sehen.“)"] },
        { term: "nescīre",      meaning:["nicht wissen", "nicht kennen", "nicht verstehen"] },
        { term: "Sicilia",      meaning:["Sizilien"] },
        { term: "Aetna",        meaning:["der Ätna"] },
        { term: "ut",           meaning:["wie"] },
        { term: "Vulcānus",     meaning:["Vulkan(us) (Gott des Feuers)"] },
        { term: "habitāre",     meaning:["wohnen", "bewohnen"] }
      ],
      "Lektion 11": [
        { term: "discīpulus",   meaning:["der Schüler"] },
        { term: "ingenium",     meaning:["die Begabung", "das Talent", "der Verstand"] },
        { term: "cōnsilium",    meaning:["die Beratung", "der Beschluss", "der Plan", "der Rat"] },
        { term: "hodiē",        meaning:["heute (Adv.)"] },
        { term: "Capitōlium",   meaning:["das Kapitol (bedeutendster Hügel Roms)"] },
        { term: "templum",      meaning:["der Tempel"] },
        { term: "aedificium",   meaning:["das Gebäude"] },
        { term: "forum",        meaning:["das Forum", "der Marktplatz"] },
        { term: "cūria",        meaning:["die Kurie (Sitzungsgebäude des Senats)"] },
        { term: "dea",          meaning:["die Göttin"] },
        { term: "Sātūrnus",     meaning:["Saturn (der Gott der Saat und der Zeit)"] },
        { term: "Cōncordia",    meaning:["Concordia (die Göttin der Eintracht)"] },
        { term: "studium",      meaning:["die Beschäftigung", "das Engagement", "das Interesse"] },
        { term: "aedificāre",   meaning:["bauen"] },
        { term: "porta",        meaning:["das Tor"] },
        { term: "beneficium",   meaning:["die Wohltat"] },
        { term: "frūmentum",    meaning:["das Getreide"] },
        { term: "statua",       meaning:["die Statue"] },
        { term: "dōnum",        meaning:["das Geschenk"] },
        { term: "verbum",       meaning:["das Wort", "die Äußerung"] }
      ],
      "Lektion 12": [
        { term: "basilica",      meaning:["die Markthalle", "die Gerichtshalle"] },
        { term: "ad",            meaning:["zu, bei, nach, an (m. Akk.)"] },
        { term: "ad portam esse / venīre", meaning:["beim Tor sein", "zum Tor kommen"] },
        { term: "ante",          meaning:["vor (m. Akk.)"] },
        { term: "ante vīllam / ante cēnam", meaning:["vor dem Landhaus", "vor dem Essen"] },
        { term: "umbra",         meaning:["der Schatten"] },
        { term: "post",          meaning:["hinter, nach (m. Akk.)"] },
        { term: "post vīllam / post cēnam", meaning:["hinter dem Landhaus", "nach dem Essen"] },
        { term: "ōrnāmentum",   meaning:["der Schmuck", "das Schmuckstück"] },
        { term: "cum",           meaning:["mit (m. Abl.)"] },
        { term: "quīnque",       meaning:["fünf"] },
        { term: "sex",           meaning:["sechs"] },
        { term: "septem",        meaning:["sieben"] },
        { term: "probāre",       meaning:["für gut befinden"] },
        { term: "pretium",       meaning:["der Preis", "der Wert"] },
        { term: "indīcāre",      meaning:["anzeigen", "melden"] },
        { term: "sine",          meaning:["ohne (Präp. m. Abl.)"] },
        { term: "e/ex",          meaning:["aus", "von … her (Präp. m. Abl.)"] },
        { term: "in",            meaning:["in, an, auf, bei (wo? – Präp. m. Abl.)"] },
        { term: "in aquā",       meaning:["im Wasser (Präp. m. Abl.)"] },
        { term: "manēre",        meaning:["bleiben", "(er)warten"] },
        { term: "in (m. Akk.)",  meaning:["in … hinein, nach (wohin?)"] },
        { term: "in aquam",      meaning:["ins Wasser (Präp. m. Akk.)"] }
      ],
      "Lektion 13": [
        { term: "ego",            meaning:["ich (betont)"] },
        { term: "tū",             meaning:["du (betont)"] },
        { term: "-ne",            meaning:["Partikel im dir. Fragesatz (unübersetzt)"] },
        { term: "vidēsne aedificium?", meaning:["Siehst du das Gebäude?"] },
        { term: "vōs",            meaning:["ihr (betont)", "euch (Akk.)"] },
        { term: "mihi",           meaning:["mir (Dat.)"] },
        { term: "mē",             meaning:["mich (Akk.)"] },
        { term: "tēcum",          meaning:["mit dir"] },
        { term: "nōs",            meaning:["wir (betont)"] },
        { term: "vōbīscum",       meaning:["mit euch"] },
        { term: "tibi",           meaning:["dir (Dat.)"] },
        { term: "nos",            meaning:["uns (Akk.)"] },
        { term: "nōbīs",          meaning:["uns (Dat.)"] },
        { term: "vobis",          meaning:["euch (Dat.)"] },
        { term: "ita",            meaning:["so"] },
        { term: "vos",            meaning:["euch (Akk.)"] },
        { term: "clamare",        meaning:["laut rufen", "schreien"] },
        { term: "errare",         meaning:["umherirren", "(sich) irren"] },
        { term: "invenire",       meaning:["finden", "erfinden"] },
        { term: "te",             meaning:["dich (Akk.)"] },
        { term: "sine me",        meaning:["ohne mich"] },
        { term: "liberare",       meaning:["befreien", "freilassen"] }
      ]
    };

    // ### Hilfsfunktionen ###
    const clean = s => s.toLowerCase().replace(/^(der|die|das)\s+/, '').trim();
    function allVocab() { return Object.entries(lessons).flatMap(([lek, arr]) => arr.map(v => ({ ...v, lesson: lek }))); }
    function shuffle(a) { return a.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(v => v[1]); }
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    // ### DOM-Referenzen ###
    const refs = {
      mainMenu: document.getElementById('main-menu'),
      startTest: document.getElementById('start-test'),
      testRed: document.getElementById('test-red'),
      viewChapters: document.getElementById('view-chapters'),
      customLists: document.getElementById('custom-lists'),
      startChallenge: document.getElementById('start-challenge'),
      testTypeSelection: document.getElementById('test-type-selection'),
      testChapters: document.getElementById('test-chapters'),
      testLists: document.getElementById('test-lists'),
      listSelection: document.getElementById('list-selection'),
      listSelectionUl: document.getElementById('list-selection-ul'),
      backFromListSelection: document.getElementById('back-from-list-selection'),
      countSel: document.getElementById('count-selection'),
      chooseCount: document.getElementById('choose-count'),
      customDiv: document.getElementById('custom-count-div'),
      customBtn: document.getElementById('custom-count-btn'),
      chapDisp: document.getElementById('chapter-display'),
      backChap: document.getElementById('back-from-chapter'),
      searchInput: document.getElementById('search-input'),
      chapSel: document.getElementById('chapter-selection'),
      chapList: document.getElementById('chapter-list'),
      challengeDisp: document.getElementById('challenge-display'),
      challengeRange: document.getElementById('challenge-range'),
      challengeVal: document.getElementById('challenge-val'),
      challengeStart: document.getElementById('challenge-start'),
      quizSection: document.getElementById('quiz-section'),
      questionTerm: document.getElementById('question-term'),
      answerInput: document.getElementById('answer-input'),
      feedbackEl: document.getElementById('feedback'),
      submitAnswer: document.getElementById('submit-answer'),
      progressEl: document.getElementById('progress'),
      resultSection: document.getElementById('result-section'),
      resultText: document.getElementById('result-text'),
      reviewCont: document.getElementById('review-container'),
      backMenu: document.getElementById('back-menu'),
      homeBtn: document.getElementById('home-btn'),
      flameCountEl: document.getElementById('flame-count'),
      customListsSection: document.getElementById('custom-lists-section'),
      backFromLists: document.getElementById('back-from-lists'),
      createNewListBtn: document.getElementById('create-new-list'),
      customListsUl: document.getElementById('custom-lists-ul'),
      listDetailSection: document.getElementById('list-detail-section'),
      listDetailTitle: document.getElementById('list-detail-title'),
      listDetailUl: document.getElementById('list-detail-ul'),
      backFromDetail: document.getElementById('back-from-detail'),
      newTerm: document.getElementById('new-term'),
      newMeaning: document.getElementById('new-meaning'),
      addVocabInline: document.getElementById('add-vocab-inline'),
      lessonDropdown: document.getElementById('lesson-dropdown'),
      darkmodeToggle: document.getElementById('darkmode-toggle')
    };

    // ### Zustand ###
    let state = {
      selectedChapters: new Set(["all"]),
      greenFolder: [],
      yellowFolder: [],
      redFolder: [],
      testList: [],
      idx: 0,
      searchHistory: JSON.parse(localStorage.getItem('searchHistory') || '[]'),
      customListsArr: JSON.parse(localStorage.getItem('customLists') || '[]'),
      currentListIndex: null,
      flameCount: parseInt(localStorage.getItem('flameCount') || '0'),
      lastDate: localStorage.getItem('lastChallengeDate') || '',
      selectedTestType: null,
      selectedListForTest: null,
      maxVocabCount: null,
      isChallenge: false
    };

    // ### Persistenz ###
    function loadFolders() {
      state.greenFolder = JSON.parse(localStorage.getItem('greenFolder') || '[]');
      state.yellowFolder = JSON.parse(localStorage.getItem('yellowFolder') || '[]');
      state.redFolder = JSON.parse(localStorage.getItem('redFolder') || '[]');
    }
    function saveFolders() {
      localStorage.setItem('greenFolder', JSON.stringify([...new Set(state.greenFolder)]));
      localStorage.setItem('yellowFolder', JSON.stringify([...new Set(state.yellowFolder)]));
      localStorage.setItem('redFolder', JSON.stringify([...new Set(state.redFolder)]));
    }
    function saveHistory() {
      localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
    }
    loadFolders();

    // ### Flames & Challenge ###
    const today = new Date().toISOString().slice(0, 10);
    refs.flameCountEl.textContent = state.flameCount ? `${state.flameCount}🔥` : '';
    function updateChallengeButton() {
      if (state.lastDate === today) {
        refs.startChallenge.classList.add('disabled');
      } else {
        refs.startChallenge.classList.remove('disabled');
      }
    }
    updateChallengeButton();

    // ### Dropdown Multiselect ###
    Object.keys(lessons).forEach(lek => {
      const li = document.createElement('li');
      li.innerHTML = `<label class="dropdown-item">
        <input type="checkbox" class="form-check-input chap-checkbox" data-lesson="${lek}">${lek}
      </label>`;
      refs.lessonDropdown.appendChild(li);
    });
    refs.lessonDropdown.querySelectorAll('.chap-checkbox').forEach(cb => {
      cb.addEventListener('change', e => {
        const lek = e.target.dataset.lesson;
        if (lek === 'all') {
          if (e.target.checked) {
            state.selectedChapters = new Set(['all']);
            refs.lessonDropdown.querySelectorAll('.chap-checkbox')
              .forEach(c => c.checked = (c.dataset.lesson === 'all'));
          }
        } else {
          if (e.target.checked) {
            state.selectedChapters.add(lek);
            state.selectedChapters.delete('all');
            refs.lessonDropdown.querySelector('[data-lesson="all"]').checked = false;
          } else {
            state.selectedChapters.delete(lek);
            if (state.selectedChapters.size === 0) {
              state.selectedChapters = new Set(['all']);
              refs.lessonDropdown.querySelector('[data-lesson="all"]').checked = true;
            }
          }
        }
      });
    });

    // ### Test-Typ Auswahl ###
    refs.startTest.addEventListener('click', () => {
      hide(refs.mainMenu);
      show(refs.testTypeSelection);
    });

    refs.testChapters.addEventListener('click', () => {
      state.selectedTestType = 'chapters';
      state.maxVocabCount = allVocab().length;
      hide(refs.testTypeSelection);
      show(refs.countSel);
      adjustCountSelection(state.maxVocabCount);
    });

    refs.testLists.addEventListener('click', () => {
      state.selectedTestType = 'lists';
      hide(refs.testTypeSelection);
      show(refs.listSelection);
      loadListSelection();
    });

    refs.backFromListSelection.addEventListener('click', () => {
      hide(refs.listSelection);
      show(refs.testTypeSelection);
    });

    // ### Listen ausfragen ###
    function loadListSelection() {
      refs.listSelectionUl.innerHTML = '';
      state.customListsArr.forEach((list, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = list.name;
        li.onclick = () => selectListForTest(index);
        refs.listSelectionUl.appendChild(li);
      });
    }

    function selectListForTest(index) {
      state.selectedListForTest = index;
      state.maxVocabCount = state.customListsArr[index].vocabs.length;
      hide(refs.listSelection);
      show(refs.countSel);
      adjustCountSelection(state.maxVocabCount);
    }

    // ### Wortanzahl-Auswahl ###
    function adjustCountSelection(maxCount) {
      const countButtons = refs.countSel.querySelectorAll('[data-count]');
      countButtons.forEach(btn => {
        const count = parseInt(btn.dataset.count);
        if (count > maxCount) {
          btn.classList.add('disabled');
          btn.disabled = true;
        } else {
          btn.classList.remove('disabled');
          btn.disabled = false;
        }
      });
      refs.customDiv.querySelector('#custom-count').max = maxCount;
    }

    refs.countSel.addEventListener('click', e => {
      if (e.target.classList.contains('btn') && !e.target.classList.contains('disabled') && e.target.dataset.count) {
        const count = parseInt(e.target.dataset.count);
        beginTest(false, count);
      }
    });

    refs.chooseCount.addEventListener('click', () => refs.customDiv.classList.remove('hidden'));
    refs.customBtn.addEventListener('click', () => {
      const n = parseInt(document.getElementById('custom-count').value);
      if (n > 0 && n <= state.maxVocabCount) {
        beginTest(false, n);
      } else {
        alert(`Bitte eine Zahl zwischen 1 und ${state.maxVocabCount} eingeben.`);
      }
    });

    // ### Kapitel ansehen ###
    function populateChapters() {
      refs.chapSel.innerHTML = '';
      refs.chapList.innerHTML = '';
      Object.keys(lessons).forEach(lek => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-secondary btn-chap';
        btn.textContent = lek;
        btn.onclick = () => {
          refs.chapList.innerHTML = '';
          lessons[lek].forEach(v => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${v.term} — ${v.meaning}`;
            refs.chapList.appendChild(li);
          });
        };
        refs.chapSel.appendChild(btn);
      });
    }
    refs.viewChapters.addEventListener('click', () => {
      hide(refs.mainMenu);
      show(refs.chapDisp);
      refs.searchInput.value = '';
      populateChapters();
    });
    refs.backChap.addEventListener('click', goHome);

    // ### Challenge Handling ###
    refs.startChallenge.addEventListener('click', () => {
      if (state.lastDate === today) {
        alert("Du hast die Challenge heute schon abgeschlossen 😎");
        return;
      }
      let up = localStorage.getItem('challengeUpTo') || 1;
      refs.challengeRange.value = up;
      refs.challengeVal.textContent = `Kapitel ${up}`;
      hide(refs.mainMenu);
      show(refs.challengeDisp);
    });
    refs.challengeRange.addEventListener('input', () => {
      refs.challengeVal.textContent = `Kapitel ${refs.challengeRange.value}`;
      localStorage.setItem('challengeUpTo', refs.challengeRange.value);
    });
    refs.challengeStart.addEventListener('click', () => {
      const up = parseInt(refs.challengeRange.value);
      const all = allVocab().filter(v => parseInt(v.lesson.split(' ')[1]) <= up);
      if (!all.length) return alert('Keine Vokabeln in den gewählten Kapiteln.');
      state.testList = shuffle(all).slice(0, 20);
      state.idx = 0;
      state.isChallenge = true;
      hide(refs.challengeDisp);
      show(refs.quizSection);
      showQuestion();
    });

    // ### Quiz / Test-Logik ###
    refs.testRed.addEventListener('click', () => beginTest(true));
    function beginTest(useRed = false, count = null) {
      let src;
      if (useRed) {
        src = state.redFolder.map(t => allVocab().find(v => v.term === t)).filter(Boolean);
      } else if (state.selectedTestType === 'lists') {
        src = state.customListsArr[state.selectedListForTest].vocabs.map(v => ({ term: v.term, meaning: v.meaning }));
      } else if (state.selectedTestType === 'chapters') {
        if (state.selectedChapters.has('all')) {
          src = allVocab();
        } else {
          src = [...state.selectedChapters].flatMap(lek => lessons[lek].map(v => ({ ...v, lesson: lek })));
        }
      }
      if (!src || !src.length) {
        alert(useRed ? 'Keine roten Vokabeln.' : 'Keine Vokabeln in dieser Auswahl.');
        goHome();
        return;
      }
      const n = (!count || count > src.length) ? src.length : count;
      state.testList = shuffle(src).slice(0, n);
      state.idx = 0;
      state.isChallenge = false;
      hide(refs.countSel);
      hide(refs.mainMenu);
      show(refs.quizSection);
      showQuestion();
    }

    function showQuestion() {
      const it = state.testList[state.idx];
      refs.questionTerm.textContent = it.term;
      refs.answerInput.value = '';
      refs.feedbackEl.textContent = '';
      refs.progressEl.textContent = `${state.idx + 1} / ${state.testList.length}`;
      refs.answerInput.focus();
    }

    function check() {
      const it = state.testList[state.idx];
      const input = clean(refs.answerInput.value);
      if (!input) {
        refs.feedbackEl.textContent = 'Bitte eingeben.';
        return;
      }
      const meaning = clean(it.meaning);
      let status;
      if (input === meaning) {
        status = 'flash-green';
        state.greenFolder.push(it.term);
        state.redFolder = state.redFolder.filter(t => t !== it.term);
      } else {
        status = 'flash-red';
        state.redFolder.push(it.term);
        state.greenFolder = state.greenFolder.filter(t => t !== it.term);
      }
      saveFolders();
      const cardEl = refs.quizSection.querySelector('.card');
      cardEl.classList.add(status);
      refs.feedbackEl.textContent = status === 'flash-green' ? '✅ Richtig!' : `❌ Falsch! Richtig: ${it.meaning}`;
      setTimeout(() => {
        cardEl.classList.remove(status);
        if (state.idx < state.testList.length - 1) {
          state.idx++;
          showQuestion();
        } else finishTest();
      }, 800);
    }

    function finishTest() {
      hide(refs.quizSection);
      refs.resultText.innerHTML = `
        <span class="badge bg-success me-2">Grün: ${state.greenFolder.length}</span>
        <span class="badge bg-danger">Rot: ${state.redFolder.length}</span>`;
      refs.reviewCont.innerHTML = '';
      state.testList.forEach(r => {
        const d = document.createElement('div');
        d.className = 'mt-2';
        d.textContent = `${r.term}: ${r.meaning} (${state.greenFolder.includes(r.term) ? 'Richtig' : 'Falsch'})`;
        refs.reviewCont.appendChild(d);
      });
      show(refs.resultSection);
      if (state.isChallenge && state.lastDate !== today) {
        state.flameCount++;
        localStorage.setItem('flameCount', state.flameCount);
        localStorage.setItem('lastChallengeDate', today);
        state.lastDate = today;
        refs.flameCountEl.textContent = `${state.flameCount}🔥`;
        updateChallengeButton();
      }
    }

    refs.submitAnswer.addEventListener('click', check);
    refs.answerInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        check();
      }
    });

    // ### Navigation ###
    function goHome() {
      hide(refs.quizSection);
      hide(refs.resultSection);
      hide(refs.countSel);
      hide(refs.chapDisp);
      hide(refs.challengeDisp);
      hide(refs.customListsSection);
      hide(refs.listDetailSection);
      hide(refs.listSelection);
      hide(refs.testTypeSelection);
      show(refs.mainMenu);
    }
    refs.backMenu.addEventListener('click', goHome);
    refs.homeBtn.addEventListener('click', goHome);

    // ### Eigene Listen ###
    function saveCustomLists() {
      localStorage.setItem('customLists', JSON.stringify(state.customListsArr));
    }

    function loadCustomLists() {
      refs.customListsUl.innerHTML = '';
      state.customListsArr.forEach((list, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = list.name;
        li.onclick = () => openList(index);
        refs.customListsUl.appendChild(li);
      });
    }

    refs.createNewListBtn.addEventListener('click', () => {
      const name = prompt('Name der neuen Liste:');
      if (name) {
        state.customListsArr.push({ name, vocabs: [] });
        saveCustomLists();
        loadCustomLists();
      }
    });

    function updateListDisplay(index) {
      refs.listDetailUl.innerHTML = '';
      state.customListsArr[index].vocabs.forEach((vocab, vocabIndex) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between';
        li.innerHTML = `${vocab.term} — ${vocab.meaning} <button class="btn btn-danger btn-sm" onclick="removeVocab(${index}, ${vocabIndex})">Löschen</button>`;
        refs.listDetailUl.appendChild(li);
      });
    }

    function openList(index) {
      state.currentListIndex = index;
      refs.listDetailTitle.textContent = state.customListsArr[index].name;
      updateListDisplay(index);
      hide(refs.customListsSection);
      show(refs.listDetailSection);
    }

    window.removeVocab = function(listIndex, vocabIndex) {
      state.customListsArr[listIndex].vocabs.splice(vocabIndex, 1);
      saveCustomLists();
      updateListDisplay(listIndex);
    };

    refs.customLists.addEventListener('click', () => {
      hide(refs.mainMenu);
      show(refs.customListsSection);
      loadCustomLists();
    });
    refs.backFromLists.addEventListener('click', goHome);
    refs.backFromDetail.addEventListener('click', () => {
      hide(refs.listDetailSection);
      show(refs.customListsSection);
    });

    refs.addVocabInline.addEventListener('click', () => {
      if (state.currentListIndex === null) return;
      const term = refs.newTerm.value.trim();
      const meaning = refs.newMeaning.value.trim();
      if (term && meaning) {
        state.customListsArr[state.currentListIndex].vocabs.push({ term, meaning });
        saveCustomLists();
        updateListDisplay(state.currentListIndex);
        refs.newTerm.value = '';
        refs.newMeaning.value = '';
      } else {
        alert('Bitte beide Felder ausfüllen.');
      }
    });

    // ### Darkmode ###
    function toggleDarkmode() {
      document.body.classList.toggle('dark-mode');
      const isDarkmode = document.body.classList.contains('dark-mode');
      refs.darkmodeToggle.innerHTML = isDarkmode ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
      localStorage.setItem('darkmode', isDarkmode);
    }
    refs.darkmodeToggle.addEventListener('click', toggleDarkmode);
    const savedDarkmode = localStorage.getItem('darkmode');
    if (savedDarkmode === 'true') {
      document.body.classList.add('dark-mode');
      refs.darkmodeToggle.innerHTML = '<i class="bi bi-sun"></i>';
    }
  });
  </script>
</body>
</html>
